@model Proyecto_Final_Desarrollo_Web.ViewModels.CarritoViewModel

@{
    ViewBag.Title = "Proceder al Pago - FarmaU";
}

<div class="container pt-4">
    <div class="row justify-content-center">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Carrito")">Mi Carrito</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Proceder al Pago</li>
                </ol>
            </nav>

            <div class="row">
                <!-- Columna de Productos -->
                <div class="col-lg-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0"><i class="bi bi-cart-check me-2"></i>Resumen de Productos</h4>
                        </div>
                        <div class="card-body">
                            @if (!Model.Items.Any())
                            {
                                <div class="text-center py-4">
                                    <i class="bi bi-cart-x text-muted" style="font-size: 3rem;"></i>
                                    <h4 class="mt-3">Tu carrito está vacío</h4>
                                    <p class="text-muted">Debes agregar productos antes de proceder al pago.</p>
                                    <a href="@Url.Action("Index", "Productos")" class="btn btn-primary mt-2">
                                        <i class="bi bi-shop me-2"></i>Ir a la tienda
                                    </a>
                                </div>
                            }
                            else
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th style="width: 50px;"></th>
                                                <th>Producto</th>
                                                <th class="text-center">Cantidad</th>
                                                <th class="text-end">Precio</th>
                                                <th class="text-end">Subtotal</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in Model.Items)
                                            {
                                                <tr>
                                                    <td class="align-middle">
                                                        <img src="@(item.ImagenUrl ?? "/Content/images/no-image.png")"
                                                             alt="@item.NombreProducto" class="img-thumbnail"
                                                             style="width: 40px; height: 40px; object-fit: cover;">
                                                    </td>
                                                    <td class="align-middle">
                                                        <h6 class="mb-0 small">@item.NombreProducto</h6>
                                                    </td>
                                                    <td class="text-center align-middle">@item.Cantidad</td>
                                                    <td class="text-end align-middle">₡@item.PrecioUnitario.ToString("N2")</td>
                                                    <td class="text-end align-middle">₡@((item.PrecioUnitario * item.Cantidad).ToString("N2"))</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Información de Pago y Envío -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0"><i class="bi bi-person-badge me-2"></i>Información de Envío y Pago</h4>
                        </div>
                        <div class="card-body">
                            <form id="checkoutForm" action="@Url.Action("ConfirmarPedido", "Carrito")" method="post">
                                @Html.AntiForgeryToken()

                                <!-- Datos Personales -->
                                <div class="mb-4">
                                    <h5 class="mb-3">Datos Personales</h5>

                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="Nombre" class="form-label">Nombre</label>
                                            <input type="text" class="form-control" id="Nombre" name="Nombre" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="Apellidos" class="form-label">Apellidos</label>
                                            <input type="text" class="form-control" id="Apellidos" name="Apellidos" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="Email" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="Email" name="Email" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="Telefono" class="form-label">Teléfono</label>
                                            <input type="tel" class="form-control" id="Telefono" name="Telefono" required>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dirección de Envío -->
                                <div class="mb-4">
                                    <h5 class="mb-3">Dirección de Envío</h5>

                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="Direccion" class="form-label">Dirección</label>
                                            <input type="text" class="form-control" id="Direccion" name="Direccion" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="Ciudad" class="form-label">Ciudad</label>
                                            <input type="text" class="form-control" id="Ciudad" name="Ciudad" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="Provincia" class="form-label">Provincia</label>
                                            <select class="form-select" id="Provincia" name="Provincia" required>
                                                <option value="">Seleccionar...</option>
                                                <option value="San José">San José</option>
                                                <option value="Alajuela">Alajuela</option>
                                                <option value="Cartago">Cartago</option>
                                                <option value="Heredia">Heredia</option>
                                                <option value="Guanacaste">Guanacaste</option>
                                                <option value="Puntarenas">Puntarenas</option>
                                                <option value="Limón">Limón</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="CodigoPostal" class="form-label">Código Postal</label>
                                            <input type="text" class="form-control" id="CodigoPostal" name="CodigoPostal" required>
                                        </div>
                                    </div>
                                </div>

                                <!-- Método de Pago -->
                                <div class="mb-4">
                                    <h5 class="mb-3">Método de Pago</h5>

                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="MetodoPago" id="tarjetaCredito" value="tarjetaCredito" checked>
                                        <label class="form-check-label" for="tarjetaCredito">
                                            <i class="bi bi-credit-card me-2"></i>Tarjeta de Crédito/Débito
                                        </label>
                                    </div>

                                    <div id="tarjetaCreditoForm" class="mt-3">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label for="NumeroTarjeta" class="form-label">Número de Tarjeta</label>
                                                <input type="text" class="form-control" id="NumeroTarjeta" name="NumeroTarjeta" placeholder="1234 5678 9012 3456" required>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="FechaVencimiento" class="form-label">Fecha de Vencimiento</label>
                                                <input type="text" class="form-control" id="FechaVencimiento" name="FechaVencimiento" placeholder="MM/AA" required>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="CVV" class="form-label">CVV</label>
                                                <input type="text" class="form-control" id="CVV" name="CVV" placeholder="123" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="NombreTarjeta" class="form-label">Nombre en la Tarjeta</label>
                                                <input type="text" class="form-control" id="NombreTarjeta" name="NombreTarjeta" required>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-check mt-3 mb-2">
                                        <input class="form-check-input" type="radio" name="MetodoPago" id="paypal" value="paypal">
                                        <label class="form-check-label" for="paypal">
                                            <i class="bi bi-paypal me-2"></i>PayPal
                                        </label>
                                    </div>

                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="radio" name="MetodoPago" id="contraentrega" value="contraentrega">
                                        <label class="form-check-label" for="contraentrega">
                                            <i class="bi bi-cash me-2"></i>Pago contra entrega
                                        </label>
                                    </div>
                                </div>

                                <!-- Notas adicionales -->
                                <div class="mb-3">
                                    <label for="Notas" class="form-label">Notas adicionales (opcional)</label>
                                    <textarea class="form-control" id="Notas" name="Notas" rows="3"></textarea>
                                </div>

                                <!-- Términos y Condiciones -->
                                <div class="form-check mb-4">
                                    <input class="form-check-input" type="checkbox" id="terminos" name="terminos" required>
                                    <label class="form-check-label" for="terminos">
                                        Acepto los <a href="#" data-bs-toggle="modal" data-bs-target="#terminosModal">Términos y Condiciones</a>
                                    </label>
                                    <div class="invalid-feedback">
                                        Debes aceptar los términos y condiciones para continuar.
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Columna de Resumen -->
                <div class="col-lg-4">
                    <div class="card shadow-sm mb-4 sticky-top" style="top: 20px; z-index: 99;">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Resumen del Pedido</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush mb-3">
                                <li class="list-group-item d-flex justify-content-between align-items-center p-3">
                                    <span>Subtotal (@Model.TotalItems artículos)</span>
                                    <span class="fw-bold">₡@Model.Subtotal.ToString("N2")</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center p-3">
                                    <span>IVA (13%)</span>
                                    <span>₡@Model.InformacionPago.Impuesto.ToString("N2")</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center p-3">
                                    <span>Gastos de envío</span>
                                    @if (Model.InformacionPago.GastosEnvio == 0)
                                    {
                                        <span class="text-success">¡Gratis!</span>
                                    }
                                    else
                                    {
                                        <span>₡@Model.InformacionPago.GastosEnvio.ToString("N2")</span>
                                    }
                                </li>
                                @if (Model.InformacionPago.Descuento > 0)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center p-3 text-success">
                                        <span>Descuento aplicado</span>
                                        <span>-₡@Model.InformacionPago.Descuento.ToString("N2")</span>
                                    </li>
                                }
                                <li class="list-group-item d-flex justify-content-between align-items-center p-3 bg-light">
                                    <span class="fw-bold">Total a pagar</span>
                                    <span class="fs-5 fw-bold text-primary">₡@Model.InformacionPago.Total.ToString("N2")</span>
                                </li>
                            </ul>

                            <div class="mb-3">
                                <label for="cuponDescuento" class="form-label fw-bold">Cupón de descuento</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="cuponDescuento" placeholder="Ingresa tu código">
                                    <button class="btn btn-outline-primary" type="button" id="aplicarCuponBtn">Aplicar</button>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="button" id="btnConfirmarPedido" class="btn btn-success">
                                    <i class="bi bi-check2-circle me-2"></i>Confirmar Pedido
                                </button>
                                <a href="@Url.Action("Index", "Carrito")" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-2"></i>Volver al Carrito
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Tarjeta de envío gratis -->
                    @if (Model.Subtotal < 30000)
                    {
                        decimal faltante = 30000 - Model.Subtotal;
                        <div class="card shadow-sm mb-4 border-success">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-truck text-success me-3 fs-3"></i>
                                    <div>
                                        <h6 class="mb-1">¡Estás a ₡@faltante.ToString("N0") del envío gratis!</h6>
                                        <p class="mb-0 small">Agrega más productos para obtener envío gratuito en tu compra.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="card shadow-sm mb-4 border-success">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-check-circle-fill text-success me-3 fs-3"></i>
                                    <div>
                                        <h6 class="mb-1">¡Felicidades! Tu envío es gratis</h6>
                                        <p class="mb-0 small">Has superado el monto mínimo para envío gratuito.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Tarjeta de medios de pago -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <h6 class="mb-3"><i class="bi bi-shield-check me-2"></i>Pagos seguros</h6>
                            <div class="d-flex gap-2 mb-2">
                                <span class="badge bg-light text-dark border"><i class="bi bi-credit-card me-1"></i> Visa</span>
                                <span class="badge bg-light text-dark border"><i class="bi bi-credit-card me-1"></i> Mastercard</span>
                                <span class="badge bg-light text-dark border"><i class="bi bi-paypal me-1"></i> PayPal</span>
                            </div>
                            <small class="text-muted">Todas las transacciones son seguras y están encriptadas.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Términos y Condiciones -->
<div class="modal fade" id="terminosModal" tabindex="-1" aria-labelledby="terminosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="terminosModalLabel">Términos y Condiciones</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5>1. Aceptación de los términos</h5>
                <p>Al realizar una compra en FarmaU, usted acepta los siguientes términos y condiciones en su totalidad.</p>

                <h5>2. Pedidos y pagos</h5>
                <p>Todos los pedidos están sujetos a la disponibilidad de productos. Los precios mostrados incluyen el IVA correspondiente.</p>

                <h5>3. Política de envío</h5>
                <p>Los pedidos superiores a ₡30,000 tienen envío gratuito en todo el país. Para pedidos menores, se aplicará un cargo por envío que será notificado antes de finalizar la compra.</p>

                <h5>4. Política de devoluciones</h5>
                <p>Puede solicitar una devolución dentro de los 14 días posteriores a la recepción del producto. Los medicamentos no son retornables por razones de seguridad.</p>

                <h5>5. Protección de datos</h5>
                <p>Sus datos personales serán tratados de acuerdo con nuestra política de privacidad, cumpliendo con la legislación vigente.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendido</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function () {
            // Manejar cambio de método de pago
            $('input[name="MetodoPago"]').change(function () {
                if ($(this).val() === 'tarjetaCredito') {
                    $('#tarjetaCreditoForm').show();
                } else {
                    $('#tarjetaCreditoForm').hide();
                }
            });

            // Validación del formulario antes de enviar
            $('#btnConfirmarPedido').click(function (e) {
                e.preventDefault();

                // Verificar si el formulario es válido
                if (!document.getElementById('checkoutForm').checkValidity()) {
                    // Mostrar validaciones
                    $('#checkoutForm').addClass('was-validated');

                    // Scroll al primer elemento con error
                    $('input:invalid, select:invalid, textarea:invalid').first().focus();

                    Swal.fire({
                        icon: 'warning',
                        title: 'Formulario incompleto',
                        text: 'Por favor, completa todos los campos requeridos.'
                    });

                    return;
                }

                // Mostrar confirmación
                Swal.fire({
                    title: '¿Confirmar pedido?',
                    text: 'Al confirmar, se procesará tu pago y se preparará tu pedido.',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#dc3545',
                    confirmButtonText: 'Sí, confirmar pedido',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Simulación de procesamiento
                        Swal.fire({
                            title: 'Procesando pedido...',
                            text: 'Por favor espera mientras procesamos tu pedido.',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                                // Simulación de tiempo de procesamiento
                                setTimeout(() => {
                                    Swal.fire({
                                        icon: 'success',
                                        title: '¡Pedido realizado con éxito!',
                                        text: 'Recibirás un correo con los detalles de tu compra.',
                                        confirmButtonColor: '#28a745'
                                    }).then(() => {
                                        // Redirigir a una página de confirmación
                                        window.location.href = '@Url.Action("Index", "Home")';
                                    });
                                }, 2000);
                            }
                        });
                    }
                });
            });

            // Aplicar cupón de descuento
            $('#aplicarCuponBtn').click(function () {
                const cupon = $('#cuponDescuento').val().trim();
                if (cupon === '') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Cupón vacío',
                        text: 'Por favor ingresa un código de cupón válido'
                    });
                    return;
                }

                // Simulación de verificación de cupón
                Swal.fire({
                    title: 'Verificando cupón...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                        setTimeout(() => {
                            if (cupon.toUpperCase() === 'DESCUENTO10') {
                                Swal.fire({
                                    icon: 'success',
                                    title: '¡Cupón aplicado!',
                                    text: 'Se ha aplicado un 10% de descuento a tu compra.',
                                    confirmButtonColor: '#28a745'
                                }).then(() => {
                                    // Recargar la página para mostrar el descuento aplicado
                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Cupón inválido',
                                    text: 'El código ingresado no existe o ha expirado.',
                                    confirmButtonColor: '#dc3545'
                                });
                            }
                        }, 1500);
                    }
                });
            });

            // Formateo de campos
            $('#NumeroTarjeta').on('input', function() {
                $(this).val($(this).val().replace(/[^\d]/g, '').replace(/(.{4})/g, '$1 ').trim());
            });

            $('#FechaVencimiento').on('input', function() {
                let value = $(this).val().replace(/\D/g, '');
                if (value.length > 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                $(this).val(value);
            });

            $('#CVV').on('input', function() {
                $(this).val($(this).val().replace(/\D/g, '').substring(0, 3));
            });
        });
    </script>
}