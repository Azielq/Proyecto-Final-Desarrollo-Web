@model Proyecto_Final_Desarrollo_Web.ViewModels.TiendaViewModel
@{
    ViewBag.Title = Model.Productos[0].Nombre;
    var producto = Model.Productos[0];
}
<!-- estilos omitidos por brevedad (idénticos a los tuyos) -->

<nav aria-label="breadcrumb" class="bg-light py-3 mb-4">
    <!-- migas de pan idénticas -->
</nav>

<div class="container mb-5">
  <div class="card border-0 shadow-sm mb-4">
    <div class="row g-0">
      <!-- GALERÍA -->
      <div class="col-md-5 p-4 product-gallery">
        <div class="main-image mb-3">
          <img id="mainProductImage"
               src="@(producto.UrlImagen ?? "/Content/images/product-placeholder.jpg")"
               class="img-fluid rounded" style="max-height:300px;object-fit:contain;cursor:zoom-in" />
        </div>
        <div class="thumbnails d-flex flex-wrap gap-2 justify-content-center">
          <div class="thumbnail-item active">
            <img src="@(producto.UrlImagen ?? "/Content/images/product-placeholder.jpg")" />
          </div>
          @foreach(var img in ViewBag.Imagenes ?? new List<dynamic>()) {
            @if (img.URL != producto.UrlImagen) {
              <div class="thumbnail-item">
                <img src="@img.URL" />
              </div>
            }
          }
        </div>
      </div>
      <!-- INFO PRODUCTO -->
      <div class="col-md-7 p-4">
        <h1 class="h2 mb-1">@producto.Nombre</h1>
        <!-- precio, badges, rating… idénticos -->
        <div class="product-actions d-flex gap-3 flex-wrap mb-4">
          <div class="quantity-selector d-flex align-items-center">
            <button id="btnDecrease" class="btn btn-outline-secondary">−</button>
            <input type="number" id="quantity"
                   class="form-control mx-2 text-center"
                   value="1" min="1" max="@producto.Stock" />
            <button id="btnIncrease" class="btn btn-outline-secondary">+</button>
          </div>
          <button id="btnAddToCart"
                  class="btn btn-primary flex-grow-1"
                  @(producto.Stock<=0?"disabled":"")>
            <i class="bi bi-cart-plus me-2"></i>Agregar al Carrito
          </button>
          <button class="btn btn-outline-danger">
            <i class="bi bi-heart"></i>
          </button>
        </div>
        <!-- shipping info… -->
      </div>
    </div>
  </div>

  <!-- TABS DETALLES… -->
  <!-- PRODUCTOS RELACIONADOS… -->

</div>

<!-- MODAL Añadir al carrito -->
<div class="modal fade" id="addToCartModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Añadir al carrito</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="modalProductImage" src="" class="img-thumbnail mb-2" style="width:80px;height:80px;object-fit:cover" />
        <h6 id="modalProductName"></h6>
        <p>Precio: <span id="modalProductPrice" class="fw-bold"></span></p>
        <div class="input-group justify-content-center">
          <button id="decreaseModalQty" class="btn btn-outline-secondary">−</button>
          <input type="number" id="modalQuantity" class="form-control text-center" value="1" min="1" />
          <button id="increaseModalQty" class="btn btn-outline-secondary">+</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" id="confirmAddToCart">
          <i class="bi bi-cart-check me-2"></i>Añadir
        </button>
      </div>
    </div>
  </div>
</div>

@section scripts {
<script>
$(function(){

  // --- GALERÍA: cambio de miniatura + zoom on click ---
  $('.thumbnail-item').click(function(){
    $('.thumbnail-item').removeClass('active');
    $(this).addClass('active');
    let src = $(this).find('img').attr('src');
    $('#mainProductImage').fadeTo(200,0.5,()=> {
      $('#mainProductImage').attr('src', src).fadeTo(200,1);
    });
  });
  $('#mainProductImage').click(function(){
    // zoom modal
    let src = this.src;
    $('body').append(`
      <div class="modal fade" id="zoomModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-0">
        <img src="${src}" class="img-fluid"/>
      </div></div></div>`);
    new bootstrap.Modal($('#zoomModal')).show()
      ._element.addEventListener('hidden.bs.modal', ()=>$('#zoomModal').remove());
  });

  // --- SELECTOR DE CANTIDAD ---
  const maxStock = @producto.Stock;
  $('#btnDecrease').click(()=> {
    let v = +$('#quantity').val();
    if(v>1) $('#quantity').val(v-1);
  });
  $('#btnIncrease').click(()=> {
    let v = +$('#quantity').val();
    if(v<maxStock) $('#quantity').val(v+1);
  });
  $('#quantity').on('input',function(){
    let v = parseInt(this.value)||1;
    v = Math.max(1, Math.min(v, maxStock));
    $(this).val(v);
  });

  // --- ABRIR MODAL con datos del producto ---
  $('#btnAddToCart').click(function(){
    let qty = +$('#quantity').val();
    if(qty<1||qty>maxStock) {
      return Swal.fire('Cantidad inválida','Revisa tu cantidad','warning');
    }
    @* Si no está logueado, redirigir *@
    @if (Session["UserID"] == null) {
      <text>
      return Swal.fire({
        title:'Debes iniciar sesión',
        icon:'info',
        confirmButtonText:'Entrar'
      }).then(r=>{ if(r.isConfirmed) location.href='@Url.Action("Login","Usuarios")'; });
      </text>
    }
    // rellenar modal
    $('#modalProductName').text('@producto.Nombre');
    $('#modalProductPrice').text('@producto.Precio.ToString("C0")');
    $('#modalProductImage').attr('src','@(producto.UrlImagen ?? "/Content/images/product-placeholder.jpg")');
    $('#modalQuantity').val(qty);
    $('#addToCartModal').modal('show');
  });

  // --- MODAL qty controls ---
  $('#decreaseModalQty').click(()=>{
    let v=+$('#modalQuantity').val();
    if(v>1) $('#modalQuantity').val(v-1);
  });
  $('#increaseModalQty').click(()=>{
    let v=+$('#modalQuantity').val();
    if(v<maxStock) $('#modalQuantity').val(v+1);
  });
  $('#modalQuantity').on('input',function(){
    let v = parseInt(this.value)||1;
    v = Math.max(1,Math.min(v,maxStock));
    $(this).val(v);
  });

  // --- CONFIRMAR ADD TO CART AJAX ---
  var antiforgery = $('input[name="__RequestVerificationToken"]').val();
  $.ajaxSetup({ headers: { 'RequestVerificationToken': antiforgery } });

  $('#confirmAddToCart').click(()=>{
    let qty = +$('#modalQuantity').val();
    Swal.fire({ title:'Añadiendo...', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });
    $.post('@Url.Action("AgregarAjax","Carrito")',
      { idProducto:@producto.ID_Producto, cantidad:qty })
    .done(resp=>{
      Swal.close();
      if(resp.success){
        // actualiza badge
        let $b=$('.nav-link .badge');
        if($b.length) $b.text(resp.totalItems);
        else $('.nav-link.position-relative')
          .append(`<span class="badge bg-danger">${resp.totalItems}</span>`);
        Swal.fire('¡Agregado!','Producto en tu carrito','success');
      } else Swal.fire('Error',resp.message,'error');
      $('#addToCartModal').modal('hide');
    })
    .fail(()=> Swal.fire('Error','Intenta luego','error'));
  });

});  
</script>
}
