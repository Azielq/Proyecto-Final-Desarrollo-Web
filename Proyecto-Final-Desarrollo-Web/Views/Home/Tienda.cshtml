@model Proyecto_Final_Desarrollo_Web.ViewModels.TiendaViewModel

@{
    ViewBag.Title = Model.TituloPagina;
}

<!-- Encabezado -->
<div class="bg-light py-4 mb-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-0">@Model.TituloPagina</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="@Url.Action("Index","Home")">Inicio</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Tienda</li>
                    </ol>
                </nav>
            </div>
            <div class="col-md-4 text-md-end">
                <p class="mb-0 text-muted fw-bold">
                    <i class="bi bi-boxes me-1"></i>
                    Mostrando <span class="text-primary">@Model.Productos.Count</span>
                    de <span class="text-primary">@Model.TotalProductos</span> productos
                </p>
            </div>
        </div>
    </div>
</div>

<div class="container mb-5">
    <div class="row">
        <!-- FILTROS LATERALES -->
        <div class="col-lg-3 mb-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filtrar por</h5>
                </div>
                <div class="card-body">
                    @using (Html.BeginForm("Tienda","Home",FormMethod.Get,new { id="filtroForm" }))
                    {
                        <!-- Búsqueda -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Buscar:</label>
                            <div class="input-group">
                                @Html.TextBoxFor(m=>m.Filtros.Busqueda,new{ @class="form-control", placeholder="Nombre, descripción…" })
                                <button class="btn btn-primary"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                        <!-- Categoría -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Categoría:</label>
                            <select name="Filtros.CategoriaId" class="form-select">
                                <option value="">Todas</option>
                                @foreach(var cat in Model.Categorias){
                                    <option value="@cat.ID_Categoria" @(Model.Filtros.CategoriaId==cat.ID_Categoria?"selected":"")>
                                        @cat.Nombre (@cat.CantidadProductos)
                                    </option>
                                }
                            </select>
                        </div>
                        <!-- Precio -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Precio:</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    @Html.TextBoxFor(m=>m.Filtros.PrecioMinimo,new{ type="number", min="0", @class="form-control", placeholder="Mín" })
                                </div>
                                <div class="col-6">
                                    @Html.TextBoxFor(m=>m.Filtros.PrecioMaximo,new{ type="number", min="0", @class="form-control", placeholder="Máx" })
                                </div>
                            </div>
                        </div>
                        <!-- Opciones -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Opciones:</label>
                            <div class="form-check">
                                @Html.CheckBoxFor(m=>m.Filtros.SoloOfertas,new{ @class="form-check-input", id="chkOfertas" })
                                <label class="form-check-label" for="chkOfertas">Solo ofertas</label>
                            </div>
                            <div class="form-check">
                                @Html.CheckBoxFor(m=>m.Filtros.SoloNuevos,new{ @class="form-check-input", id="chkNuevos" })
                                <label class="form-check-label" for="chkNuevos">Solo nuevos</label>
                            </div>
                            <div class="form-check">
                                @Html.CheckBoxFor(m=>m.Filtros.SoloEnStock,new{ @class="form-check-input", id="chkEnStock" })
                                <label class="form-check-label" for="chkEnStock">Solo en stock</label>
                            </div>
                        </div>
                        <!-- Condiciones especiales -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Condiciones:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="Filtros.RequiereReceta" id="chkReceta"
                                       @(Model.Filtros.RequiereReceta?"checked":"") />
                                <label class="form-check-label" for="chkReceta">No requiere receta</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="Filtros.GenericoDisponible" id="chkGenerico"
                                       @(Model.Filtros.GenericoDisponible?"checked":"") />
                                <label class="form-check-label" for="chkGenerico">Genérico disponible</label>
                            </div>
                        </div>
                        <!-- Orden -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ordenar por:</label>
                            <select name="Filtros.OrdenarPor" class="form-select">
                                <option value="populares" @(Model.Filtros.OrdenarPor=="populares"?"selected":"")>Más populares</option>
                                <option value="precio_asc" @(Model.Filtros.OrdenarPor=="precio_asc"?"selected":"")>Precio ↑</option>
                                <option value="precio_desc" @(Model.Filtros.OrdenarPor=="precio_desc"?"selected":"")>Precio ↓</option>
                                <option value="nombre_asc" @(Model.Filtros.OrdenarPor=="nombre_asc"?"selected":"")>A-Z</option>
                                <option value="nombre_desc" @(Model.Filtros.OrdenarPor=="nombre_desc"?"selected":"")>Z-A</option>
                                <option value="nuevos" @(Model.Filtros.OrdenarPor=="nuevos"?"selected":"")>Más recientes</option>
                            </select>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary"><i class="bi bi-filter me-2"></i>Aplicar</button>
                            <a href="@Url.Action("Tienda","Home")" class="btn btn-outline-secondary">Limpiar</a>
                        </div>
                    }
                </div>
            </div>
            <!-- Banner ayuda -->
            <div class="card border-0 shadow-sm mt-4 bg-success text-white">
                <div class="card-body p-4 text-center">
                    <h5 class="fw-bold">¿Necesitas ayuda?</h5>
                    <p>Contáctanos para asesoría</p>
                    <hr>
                    <p><i class="bi bi-telephone me-2"></i>(800) 123-4567</p>
                    <a href="@Url.Action("Contact","Home")" class="btn btn-light">Contáctanos</a>
                </div>
            </div>
        </div>

        <!-- LISTADO DE PRODUCTOS -->
        <div class="col-lg-9">
            <!-- Vista / Orden -->
            <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded mb-4">
                <div>
                    <span class="me-2">Vista:</span>
                    <div class="btn-group">
                        <button id="gridView" class="btn btn-outline-primary active"><i class="bi bi-grid-3x3-gap"></i></button>
                        <button id="listView" class="btn btn-outline-primary"><i class="bi bi-list"></i></button>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <label class="me-2">Ordenar:</label>
                    <select id="sortSelect" class="form-select form-select-sm" style="width:auto;">
                        @* Mantiene las mismas opciones que arriba *@
                        <option value="populares" @(Model.Filtros.OrdenarPor=="populares"?"selected":"")>Más populares</option>
                        <option value="precio_asc" @(Model.Filtros.OrdenarPor=="precio_asc"?"selected":"")>Precio ↑</option>
                        <option value="precio_desc" @(Model.Filtros.OrdenarPor=="precio_desc"?"selected":"")>Precio ↓</option>
                        <option value="nombre_asc" @(Model.Filtros.OrdenarPor=="nombre_asc"?"selected":"")>A-Z</option>
                        <option value="nombre_desc" @(Model.Filtros.OrdenarPor=="nombre_desc"?"selected":"")>Z-A</option>
                        <option value="nuevos" @(Model.Filtros.OrdenarPor=="nuevos"?"selected":"")>Más recientes</option>
                    </select>
                </div>
            </div>

            @if(!Model.Productos.Any()){
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>No se encontraron productos.
                </div>
            } else {
                <!-- GRID -->
                <div id="gridContainer" class="row g-4">
                    @foreach(var prod in Model.Productos){
                        <div class="col-sm-6 col-md-4">
                            <div class="card h-100 border-0 shadow-sm product-card">
                                <div class="position-relative">
                                    <a href="@Url.Action("DetalleProducto","Home",new{ id=prod.ID_Producto })">
                                        <div class="bg-light d-flex align-items-center justify-content-center p-2" style="height:200px;">
                                            <img src="@(prod.UrlImagen??"/Content/images/product-placeholder.jpg")"
                                                 class="img-fluid" style="object-fit:contain;max-height:100%;max-width:100%;" />
                                        </div>
                                    </a>
                                    @if(prod.EsNuevo)   <span class="badge bg-success pos-absolute m-2">Nuevo</span>  @endif
                                    @if(prod.EsOferta) <span class="badge bg-danger pos-absolute top-0 end-0 m-2">-@(prod.PorcentajeDescuento*100)%</span> @endif
                                </div>
                                <div class="card-body p-3">
                                    <h5 class="fw-bold mb-1">
                                        <a href="@Url.Action("DetalleProducto","Home",new{ id=prod.ID_Producto })"
                                           class="text-decoration-none text-dark">@prod.Nombre</a>
                                    </h5>
                                    <p class="small text-muted mb-1">@prod.Categoria</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            @if(prod.EsOferta)
                                            {
                                                <span class="text-decoration-line-through text-muted me-2">@prod.PrecioOriginal.ToString("C0")</span>
                                            }
                                            <span class="fw-bold text-primary">@prod.Precio.ToString("C0")</span>
                                        </div>
                                        <div>
                                            <i class="bi bi-star-fill text-warning"></i>
                                            <span>@prod.Valoracion</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-white border-0 p-3">
                                    <div class="d-grid gap-2">
                                        <a href="@Url.Action("DetalleProducto","Home",new{ id=prod.ID_Producto })"
                                           class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-eye me-1"></i>Ver Detalles
                                        </a>
                                        <button class="btn btn-primary add-to-cart-btn btn-sm"
                                                data-product-id="@prod.ID_Producto"
                                                data-product-name="@prod.Nombre"
                                                data-product-price="@prod.Precio"
                                                data-product-image="@(prod.UrlImagen??"/Content/images/product-placeholder.jpg")">
                                            <i class="bi bi-cart-plus me-1"></i>Añadir
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- LIST -->
                <div id="listContainer" class="d-none">
                    @foreach(var prod in Model.Productos){
                        <div class="card mb-3 border-0 shadow-sm">
                            <div class="row g-0">
                                <div class="col-md-3">
                                    <a href="@Url.Action("DetalleProducto","Home",new{ id=prod.ID_Producto })">
                                        <div class="bg-light d-flex align-items-center justify-content-center p-2" style="height:180px;">
                                            <img src="@(prod.UrlImagen??"/Content/images/product-placeholder.jpg")"
                                                 class="img-fluid" style="object-fit:contain;max-height:100%;max-width:100%;" />
                                        </div>
                                    </a>
                                </div>
                                <div class="col-md-9">
                                    <div class="card-body d-flex flex-column justify-content-between">
                                        <div class="d-flex justify-content-between">
                                            <h5 class="fw-bold">
                                                <a href="@Url.Action("DetalleProducto","Home",new{ id=prod.ID_Producto })"
                                                   class="text-decoration-none text-dark">@prod.Nombre</a>
                                            </h5>
                                            <div class="text-end">
                                                @if(prod.EsOferta)
                                                {
                                                    <p class="text-decoration-line-through text-muted mb-0">@prod.PrecioOriginal.ToString("C0")</p>
                                                }
                                                <p class="fw-bold text-primary mb-0">@prod.Precio.ToString("C0")</p>
                                            </div>
                                        </div>
                                        <p class="small text-muted mb-2">@prod.Categoria</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <span class="badge bg-@(prod.Stock>0?"success":"danger")">
                                                    @(prod.Stock>0?"En stock":"Agotado")
                                                </span>
                                                @if(!string.IsNullOrEmpty(prod.Marca))
                                                {
                                                    <span class="badge bg-light text-dark ms-2">@prod.Marca</span>
                                                }
                                            </div>
                                            <div class="btn-group">
                                                <a href="@Url.Action("DetalleProducto","Home",new{ id=prod.ID_Producto })"
                                                   class="btn btn-outline-primary btn-sm"><i class="bi bi-eye me-1"></i>Ver</a>
                                                <button class="btn btn-primary btn-sm add-to-cart-btn"
                                                        data-product-id="@prod.ID_Producto"
                                                        data-product-name="@prod.Nombre"
                                                        data-product-price="@prod.Precio"
                                                        data-product-image="@(prod.UrlImagen??"/Content/images/product-placeholder.jpg")">
                                                    <i class="bi bi-cart-plus me-1"></i>Añadir
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- PAGINACIÓN -->
                @if(Model.TotalPaginas>1){
                    <nav class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item @(Model.PaginaActual==1?"disabled":"")">
                                <a class="page-link" href="@Url.Action("Tienda","Home",new{ pagina=Model.PaginaActual-1, filtro=Model.Filtros })">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            @for(int i=Math.Max(1,Model.PaginaActual-2); i<=Math.Min(Model.TotalPaginas,Model.PaginaActual+2); i++){
                                <li class="page-item @(i==Model.PaginaActual?"active":"")">
                                    <a class="page-link" href="@Url.Action("Tienda","Home",new{ pagina=i, filtro=Model.Filtros })">@i</a>
                                </li>
                            }
                            <li class="page-item @(Model.PaginaActual==Model.TotalPaginas?"disabled":"")">
                                <a class="page-link" href="@Url.Action("Tienda","Home",new{ pagina=Model.PaginaActual+1, filtro=Model.Filtros })">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                }
            }
        </div>
    </div>
</div>

<!-- MODAL Añadir al carrito -->
<div class="modal fade" id="addToCartModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Añadir al carrito</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="modalProductImage" src="" class="img-thumbnail mb-2" style="width:80px;height:80px;object-fit:cover" />
        <h6 id="modalProductName"></h6>
        <p>Precio: <span id="modalProductPrice" class="fw-bold"></span></p>
        <div class="input-group justify-content-center">
          <button id="decreaseQuantity" class="btn btn-outline-secondary">−</button>
          <input type="number" id="modalQuantity" class="form-control text-center" value="1" min="1" />
          <button id="increaseQuantity" class="btn btn-outline-secondary">+</button>
        </div>
        <input type="hidden" id="productId" />
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" id="confirmAddToCart">
          <i class="bi bi-cart-check me-2"></i>Añadir
        </button>
      </div>
    </div>
  </div>
</div>

@section scripts {
<script>
$(function(){
  // Grid / List toggle
  $('#gridView').click(function(){
    $(this).addClass('active');
    $('#listView').removeClass('active');
    $('#gridContainer').removeClass('d-none');
    $('#listContainer').addClass('d-none');
    localStorage.setItem('view','grid');
  });
  $('#listView').click(function(){
    $(this).addClass('active');
    $('#gridView').removeClass('active');
    $('#listContainer').removeClass('d-none');
    $('#gridContainer').addClass('d-none');
    localStorage.setItem('view','list');
  });
  if(localStorage.getItem('view')==='list') $('#listView').trigger('click');

  // Sort select
  $('#sortSelect').change(function(){
    $('select[name="Filtros.OrdenarPor"]').val(this.value);
    $('#filtroForm').submit();
  });

  // Add to cart modal
  $('.add-to-cart-btn').click(function(){
    var btn=$(this);
    $('#productId').val(btn.data('product-id'));
    $('#modalProductName').text(btn.data('product-name'));
    $('#modalProductPrice').text('₡'+parseFloat(btn.data('product-price')).toFixed(2));
    $('#modalProductImage').attr('src',btn.data('product-image'));
    $('#modalQuantity').val(1);
    $('#addToCartModal').modal('show');
  });

  // Qty in modal
  $('#increaseQuantity').click(function(){
    var v=+$('#modalQuantity').val(); $('#modalQuantity').val(v+1);
  });
  $('#decreaseQuantity').click(function(){
    var v=+$('#modalQuantity').val(); if(v>1) $('#modalQuantity').val(v-1);
  });

  // AJAX add to cart
  var token=$('input[name="__RequestVerificationToken"]').val();
  $.ajaxSetup({ headers:{ 'RequestVerificationToken': token }});

  $('#confirmAddToCart').click(function(){
    var id=+$('#productId').val(), qty=+$('#modalQuantity').val();
    if(id<=0||qty<=1) return Swal.fire('Error','Cantidad inválida','error');
    if(@(Session["UserID"]==null?"true":"false")) {
      return Swal.fire({
        title:'Debes iniciar sesión',
        icon:'info',
        showCancelButton:true,
        confirmButtonText:'Entrar'
      }).then(r=>r.isConfirmed?location.href='@Url.Action("Login","Usuarios")':null);
    }
    Swal.fire({ title:'Añadiendo…', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });
    $.post('@Url.Action("AgregarAjax","Carrito")',{ idProducto:id, cantidad:qty })
    .done(resp=>{
      Swal.close();
      if(resp.success){
        var $b=$('.nav-link .badge');
        if($b.length) $b.text(resp.totalItems);
        else $('.nav-link.position-relative').append('<span class="badge bg-danger">'+resp.totalItems+'</span>');
        Swal.fire('¡Agregado!','Producto en tu carrito','success');
        $('#addToCartModal').modal('hide');
      } else Swal.fire('Error',resp.message,'error');
    }).fail(()=> Swal.fire('Error','No se pudo conectar','error'));
  });

  // Auto-submit filtros
  $('#filtroForm input,#filtroForm select').change(function(){
    $('#filtroForm').submit();
  });

  // Reset filtros
  $('.btn-outline-secondary').filter('[href]').click(function(e){
    e.preventDefault(); window.location.href=window.location.pathname;
  });
});
</script>
}
