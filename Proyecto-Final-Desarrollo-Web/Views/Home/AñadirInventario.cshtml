
@{
    ViewBag.Title = "AñadirInventario";
}


<div class="container-fluid my-4">
    <div class="row">
        <!-- Sidebar de navegación -->
        <div class="col-md-3 col-lg-2">
            <div class="sidebar">
                <div class="logo-container mb-4">
                    <img src="~/imagenes/FarmaU.png" alt="FarmaU Logo" class="logo-img">
                    <h4 class="logo-text">Farma<span class="text-primary">U</span></h4>
                </div>
                <div class="menu">
                    <div class="menu-header">MENÚ PRINCIPAL</div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-shopping-cart"></i> Ventas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-truck"></i> Pedidos
                            </a>
                        </li>
                        <li class="nav-item active">
                            <a href="@Url.Action("Index", "Inventario")" class="nav-link active">
                                <i class="fas fa-boxes"></i> Inventario
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-users"></i> Clientes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-building"></i> Proveedores
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Contenido principal -->
        <div class="col-md-9 col-lg-10">
            <div class="content-header d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3">Añadir Nuevo Producto</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#">Inicio</a></li>
                            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Inventario")">Inventario</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Nuevo Producto</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <a href="@Url.Action("Index", "Inventario")" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Volver
                    </a>
                </div>
            </div>

            <!-- Formulario de producto -->
            <div class="card mb-4">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Información del Producto</h6>
                </div>
                <div class="card-body">
                    <form id="formNuevoProducto" method="post" action="@Url.Action("Guardar", "Inventario")" enctype="multipart/form-data" class="needs-validation" novalidate>
                        @Html.AntiForgeryToken()

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5 class="mb-3">Datos Básicos</h5>

                                <div class="mb-3">
                                    <label for="codigo" class="form-label">Código *</label>
                                    <input type="text" class="form-control" id="codigo" name="codigo" required maxlength="20">
                                    <div class="invalid-feedback">
                                        Por favor ingrese un código válido.
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="nombre" class="form-label">Nombre del Producto *</label>
                                    <input type="text" class="form-control" id="nombre" name="nombre" required maxlength="100">
                                    <div class="invalid-feedback">
                                        Por favor ingrese un nombre para el producto.
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="descripcion" class="form-label">Descripción</label>
                                    <textarea class="form-control" id="descripcion" name="descripcion" rows="3" maxlength="500"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="categoria" class="form-label">Categoría *</label>
                                    <select class="form-select" id="categoria" name="categoriaId" required>
                                        <option value="">Seleccione una categoría</option>
                                        <option value="1">Medicamentos</option>
                                        <option value="2">Cuidado Personal</option>
                                        <option value="3">Vitaminas y Suplementos</option>
                                        <option value="4">Bebés y Maternidad</option>
                                        <option value="5">Equipos Médicos</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Por favor seleccione una categoría.
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="proveedor" class="form-label">Proveedor *</label>
                                    <select class="form-select" id="proveedor" name="proveedorId" required>
                                        <option value="">Seleccione un proveedor</option>
                                        <option value="1">Farmacéutica Nacional</option>
                                        <option value="2">Distribuidora Médica</option>
                                        <option value="3">Insumos de Salud</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Por favor seleccione un proveedor.
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h5 class="mb-3">Precios e Inventario</h5>

                                <div class="mb-3">
                                    <label for="precioCompra" class="form-label">Precio de Compra *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="precioCompra" name="precioCompra" required min="0" step="0.01">
                                        <div class="invalid-feedback">
                                            Por favor ingrese un precio válido.
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="precioVenta" class="form-label">Precio de Venta *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="precioVenta" name="precioVenta" required min="0" step="0.01">
                                        <div class="invalid-feedback">
                                            Por favor ingrese un precio válido.
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="stockInicial" class="form-label">Stock Inicial *</label>
                                    <input type="number" class="form-control" id="stockInicial" name="stockInicial" required min="0" step="1">
                                    <div class="invalid-feedback">
                                        Por favor ingrese un stock válido.
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="stockMinimo" class="form-label">Stock Mínimo *</label>
                                    <input type="number" class="form-control" id="stockMinimo" name="stockMinimo" required min="0" step="1">
                                    <div class="invalid-feedback">
                                        Por favor ingrese un stock mínimo válido.
                                    </div>
                                    <div class="form-text">
                                        Cantidad mínima antes de mostrar alerta de stock bajo.
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="ubicacion" class="form-label">Ubicación</label>
                                    <input type="text" class="form-control" id="ubicacion" name="ubicacion" maxlength="50">
                                    <div class="form-text">
                                        Ubicación física del producto en el almacén (opcional).
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5 class="mb-3">Imagen y Archivos</h5>

                                <div class="mb-3">
                                    <label for="imagen" class="form-label">Imagen del Producto</label>
                                    <input type="file" class="form-control" id="imagen" name="imagen" accept="image/*">
                                    <div class="form-text">
                                        Formatos permitidos: JPG, PNG. Tamaño máximo: 2MB.
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="fichaTecnica" class="form-label">Ficha Técnica</label>
                                    <input type="file" class="form-control" id="fichaTecnica" name="fichaTecnica" accept=".pdf,.doc,.docx">
                                    <div class="form-text">
                                        Formatos permitidos: PDF, DOC, DOCX. Tamaño máximo: 5MB.
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h5 class="mb-3">Información Adicional</h5>

                                <div class="mb-3">
                                    <label for="fechaVencimiento" class="form-label">Fecha de Vencimiento</label>
                                    <input type="date" class="form-control" id="fechaVencimiento" name="fechaVencimiento">
                                </div>

                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="requiereReceta" name="requiereReceta" value="true">
                                    <label class="form-check-label" for="requiereReceta">Requiere Receta Médica</label>
                                </div>

                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="activo" name="activo" value="true" checked>
                                    <label class="form-check-label" for="activo">Producto Activo</label>
                                    <div class="form-text">
                                        Desmarque si el producto no debe estar disponible para la venta.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="border-top pt-3 d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="location.href='@Url.Action("Index", "Inventario")'">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Guardar Producto
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function() {
            // Validación de formulario
            $('#formNuevoProducto').submit(function(event) {
                if (!this.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }

                $(this).addClass('was-validated');

                // Validación de precio venta > precio compra
                var precioCompra = parseFloat($('#precioCompra').val());
                var precioVenta = parseFloat($('#precioVenta').val());

                if (precioVenta <= precioCompra) {
                    event.preventDefault();
                    alert('El precio de venta debe ser mayor al precio de compra.');
                }
            });

            // Cálculo automático del precio de venta (ejemplo: 30% de margen)
            $('#precioCompra').on('change', function() {
                var precioCompra = parseFloat($(this).val()) || 0;
                // Calcula precio sugerido con un 30% de margen
                var precioSugerido = (precioCompra * 1.3).toFixed(2);

                // Solo actualiza si el campo está vacío o si el usuario lo permite
                if ($('#precioVenta').val() === '' || confirm('¿Desea actualizar el precio de venta a $' + precioSugerido + '?')) {
                    $('#precioVenta').val(precioSugerido);
                }
            });

            // Vista previa de imagen
            $('#imagen').change(function() {
                if (this.files && this.files[0]) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        $('<div class="mt-2"><img src="' + e.target.result + '" class="img-thumbnail" style="max-height: 200px;"></div>')
                            .insertAfter('#imagen');
                    }
                    reader.readAsDataURL(this.files[0]);
                }
            });
        });
    </script>
}